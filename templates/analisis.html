<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnÃ¡lisis en Vivo - Monitor XAI</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>âš–ï¸ Monitor de FenÃ³menos Corruptivos</h1>
        <p>Algoritmos contra la CorrupciÃ³n - Ph.D. Vicente Humberto Monteverde</p>
        <nav>
            <a href="/">ğŸ“Š Dashboard</a>
            <a href="/analisis-vivo" class="active">ğŸš€ AnÃ¡lisis en Vivo</a>
            <a href="/documentacion">ğŸ“– DocumentaciÃ³n</a>
            <a href="/docs">ğŸ”§ API</a>
        </nav>
    </header>

    <main>
        <section class="analisis-vivo">
            <h2>ğŸ”— ConexiÃ³n Directa: Comprar.gob.ar</h2>
            <p class="info">
                Este proceso ejecuta el scraper sobre el portal de compras pÃºblicas
                y aplica la matriz XAI de detecciÃ³n de fenÃ³menos corruptivos.
            </p>
            <p class="info-aviso">
                âš ï¸ <strong>Nota:</strong> El anÃ¡lisis puede tardar entre 30 y 90 segundos
                dependiendo de la disponibilidad del portal. Los resultados quedan
                disponibles en el Dashboard durante esta sesiÃ³n.
            </p>

            <button id="btnAnalisis" onclick="ejecutarAnalisis()">
                ğŸš€ Iniciar Ciclo de AnÃ¡lisis Completo
            </button>

            <div id="spinner" class="spinner" style="display:none;">
                <div class="loader"></div>
                <p>Ejecutando Paso 1-2-3 (Scraping + Matriz + RelaciÃ³n)...</p>
                <p class="tiempo-estimado">Tiempo estimado: 30-90 segundos</p>
            </div>

            <div id="resultado" style="display:none;"></div>
        </section>
    </main>

    <script>
        async function ejecutarAnalisis() {
            const btn = document.getElementById('btnAnalisis');
            const spinner = document.getElementById('spinner');
            const resultado = document.getElementById('resultado');

            btn.disabled = true;
            spinner.style.display = 'block';
            resultado.style.display = 'none';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 min timeout

                const resp = await fetch('/api/analisis', {
                    method: 'POST',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await resp.json();

                if (resp.ok) {
                    resultado.innerHTML = `
                        <div class="exito">
                            <h3>âœ… AnÃ¡lisis completado exitosamente</h3>
                            <div class="metricas">
                                <div class="card">
                                    <h3>Procesos Analizados</h3>
                                    <span class="numero">${data.total_procesos}</span>
                                </div>
                                <div class="card">
                                    <h3>Ãndice Promedio</h3>
                                    <span class="numero">${data.indice_promedio} / 10</span>
                                </div>
                            </div>
                            <p>ğŸ“ Reporte guardado: <strong>${data.reporte}</strong></p>
                            <p><a href="/">ğŸ“Š Ver resultados en el Dashboard â†’</a></p>
                        </div>`;
                } else {
                    const detalle = data.detail || 'Error desconocido';
                    resultado.innerHTML = `
                        <div class="error">
                            <h3>âŒ Error en el anÃ¡lisis</h3>
                            <p>${detalle}</p>
                            ${detalle.includes('comprar.gob.ar') ? `
                            <p>ğŸ’¡ <strong>Sugerencia:</strong> El portal comprar.gob.ar puede no estar
                            accesible desde Railway. Intente nuevamente en unos minutos o
                            ejecute el anÃ¡lisis en su entorno local.</p>` : ''}
                        </div>`;
                }
            } catch (e) {
                let mensaje = e.message;
                if (e.name === 'AbortError') {
                    mensaje = 'Tiempo de espera agotado (2 minutos). El scraping tardÃ³ demasiado.';
                }
                resultado.innerHTML = `
                    <div class="error">
                        <h3>âŒ Error de conexiÃ³n</h3>
                        <p>${mensaje}</p>
                    </div>`;
            }

            spinner.style.display = 'none';
            resultado.style.display = 'block';
            btn.disabled = false;
        }
    </script>
</body>
</html>